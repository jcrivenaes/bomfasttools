<!DOCTYPE html>
<html>

<script language="JavaScript">
    // < !--

    const MAXTRIES = 1000;
    const MAXYEARS = 200;
    const MRD = 1000000000.0;
    const MLL = 1000000.0

    var input_byggetid = 7;
    var input_styringsramme = 10;
    var input_kostnadsramme = 12;
    var input_bompengelaan = 4;
    var input_forhaandinnkrevet = 0;
    var input_nedbetalingstid = 15;
    var input_laanerente1 = 5.5;
    var input_laanerente2 = 6.5;
    var input_laanerente_endring = 10;
    var input_prisstigning = 2;
    var input_aadtoppstart = 2030;
    var input_bomselskap = 15;
    var input_tungandel = 15;
    var input_tungmult = 3;
    var input_elbil_andel = 70;
    var input_offisielt = "vedtak"

    function compute_sumloan(loan, buildyears, rate) {
        let cum = 0.0

        let xrate = rate / 100.0;
        let xloan = loan * MRD;

        for (let year = 0; year < buildyears; year++) {
            cum = cum + Math.pow(1.0 + xrate, year);
        }
        let result = cum * xloan / buildyears;


        return (result);
    }

    function iterate_toll_value() {


        console.log("Buildyears:", buildyears)
        console.log("Loan:", loan)


        if (buildyears <= 6) {
            cumloan += compute_sumloan(loan, buildyears, rate);
        } else {
            // for buildyears > 6 think loan split into two where the first
            // at year 0 and the second at year 3
            loanhalf = loan / 2.0;
            cumloan += compute_sumloan(loanhalf, buildyears, rate);
            cumloan += compute_sumloan(loanhalf, (buildyears - 3), rate);
        }

        // rough estimate of toll as start value...
        var fracrate = rate / 100.0
        toll = ((1.0 + fracrate) * cumloan + bomselskap * trg) / (trg * 365 * aadt)
        console.log("Initial toll (1):", toll);
        finalyear = yearly_streams(cumloan, toll, rate / 100);
        console.log("Initial finalyear:", finalyear)
        if (finalyear != -1 && finalyear <= trg) {
            toll = toll / 2.0
        }
        console.log("Initial toll (2):", toll);

        console.log("CUMLOAN", cumloan);
        console.log("START TOLL VALUE IS", toll);

        var cumtotal = cumloan + trg * bomselskap

        document.result.cumloan.value = (cumloan / 1000000000).toFixed(4);
        document.result.cumloanall.value = (cumtotal / 1000000000).toFixed(4);

        allplus = cumtotal + forhaand;
        document.result.cumloanallplus.value = (allplus / 1000000000).toFixed(4);

        var bompengeinit = loan + xforhaand;
        console.log("BOMPENGEINIT =", bompengeinit)

        document.result.statandel.value = (100 * (xtotal - bompengeinit) / xtotal).toFixed(2);

        tollincrement = 1;
        if (toll > 100) tollincrement = 5;
        if (toll > 300) tollincrement = 10;


        for (var i = 0; i < MAXTRIES; i++) {
            finalyear = yearly_streams(cumloan, toll, rate / 100);
            console.log("Final year vs target:", finalyear, trg)

            if (finalyear == 1 || finalyear > trg) {
                previoustoll = toll
                toll = toll + tollincrement;
            }
            else if (finalyear == -1) {
                previoustoll = toll
                toll = toll + tollincrement
            }
            else if (finalyear < trg) {
                toll = toll - tollincrement
            }
            else {
                break;
            }

        }
        previoustoll = toll * 0.95
        console.log("ROUGH TOLL VALUE IS", toll)
        console.log("ITERATE USING", previoustoll)

        // fine tune to 50 or 10 øre
        tollincrement = 0.5
        if (toll < 50) {
            tollincrement = 0.1
        }
        toll = previoustoll;
        for (var i = 0; i < MAXTRIES; i++) {
            console.log("Fine tune, toll = ", toll)
            finalyear = yearly_streams(cumloan, toll, rate / 100);
            console.log(finalyear)

            if (finalyear == 1 || finalyear > trg) {
                toll = toll + tollincrement;
            }
            else if (finalyear == -1) {
                toll = toll + tollincrement
            }
            else if (finalyear < trg) {
                toll = toll - tollincrement
            }
            else {
                break;
            }
        }

        console.log("Proposed toll is ", toll)
        return (toll);

    }

    function yearly_streams(cumloan, toll, rate) {
        var payyears = document.calc.payyears.value;
        var aadt = document.calc.aadt.value;
        var trafficgrowth = parseFloat(document.calc.trafficgrowth.value.replace(",", ".") / 100.0);
        var bomselskap = parseFloat(document.calc.bomselskap.value.replace(",", ".") * 1000000);
        var cumincome = [];
        var cumrest = [];
        var year;

        var rest = cumloan
        var previousrest = cumloan
        console.log("INITIAL REST", rest)
        for (year = 1; year <= MAXYEARS; year++) {

            income = 365 * aadt * Math.pow((1 + trafficgrowth), (year - 1)) * toll - bomselskap;
            rest = (rest - income) * (1.0 + rate)
            console.log("YEAR", year, "REST:", rest)

            if (previousrest > 0.0 && rest <= 0.0) {
                return (year);
            }
            previousrest = rest;
        }

        return (-1);

    }

    function bycar_type(toll) {
        v = parseFloat(document.calc.elratio.value / 100.0);
        e = parseFloat(document.calc.elrabatt.value / 100.0);
        u = parseFloat(document.calc.heavyratio.value / 100.0);
        t = parseFloat(document.calc.heavymult.value);

        // person car vs heavy
        x = toll / (1 - u - v + u * v + v * e - v * e * u + u * t)

        console.log("Person vs Heavy", x, x * t)

        if (x > toll && t > 1) {
            x = NaN
            document.getElementById("umulig").innerHTML = "Umulig regnestykke, juster elbil fraksjon og/eller rabatt!";
        }
        else {
            document.getElementById("umulig").innerHTML = "";

        }

        lettfossil = x
        lettelbil = x * e
        tung = x * t

        document.result.propfossil.value = lettfossil.toFixed(1)
        document.result.propelbil.value = lettelbil.toFixed(1)
        document.result.proptung.value = tung.toFixed(1)

    }

    function main() {



        proposed_toll = iterate_toll_value();

        var emojis = ["&#128516;", "&#128528;", "&#128577;", "&#128555;", "&#128545; &#129322",
            "&#129324;&#128128;"];


        emoj = emojis[0]
        if (proposed_toll > 10) emoj = emojis[1];
        if (proposed_toll > 50) emoj = emojis[2];
        if (proposed_toll > 100) emoj = emojis[3];
        if (proposed_toll > 200) emoj = emojis[4];
        if (proposed_toll > 500) emoj = emojis[5];

        document.getElementById("emoji").innerHTML = emoj;

        var fixed = 0
        if (proposed_toll < 50) {
            fixed = 1
        }
        document.result.proposed.value = proposed_toll.toFixed(fixed)

        bycar_type(proposed_toll)

    }

    function testcase() {
        document.calc.buildyears.value = 5;
        document.calc.totalkost.value = 1.5;
        document.calc.totalkostramme.value = 1.7;
        document.calc.loan.value = 1;
        document.calc.preloan.value = 0;
        document.calc.payyears.value = 15;
        document.calc.rate.value = 5.5;
        document.calc.aadt.value = 20000;
        document.calc.trafficgrowth.value = 1;
        document.calc.bomselskap.value = 5;
        document.calc.heavyratio.value = 15;
        document.calc.heavymult.value = 3;
        document.calc.elratio.value = 0.2;
        document.calc.elrabatt.value = 50;
        document.calc.intoll.value = "14";
    }

    // https://www.regjeringen.no/contentassets/7cb4217acb094720905ba6c438cd3ab7/svv-vedlegg-1-leveranse-til-sd-endelig.pdf
    function hordfast1() {
        document.calc.buildyears.value = 7;
        document.calc.totalkost.value = 37.7;
        document.calc.totalkostramme.value = "45?"; // gjett
        document.calc.loan.value = 13.4;
        document.calc.preloan.value = 0;
        document.calc.payyears.value = 15;
        document.calc.rate.value = 5.5;
        document.calc.aadt.value = 5700;
        document.calc.trafficgrowth.value = 1.5;
        document.calc.bomselskap.value = 15;
        document.calc.heavyratio.value = 15;
        document.calc.heavymult.value = 3;
        document.calc.elratio.value = 70;
        document.calc.elrabatt.value = 50;
        document.calc.intoll.value = "352 personbil SVV 2020";
    }

    function rogfast1() {
        document.calc.buildyears.value = 10;
        document.calc.totalkost.value = 20.6;
        document.calc.totalkostramme.value = 24.8;
        document.calc.loan.value = 10.66;
        document.calc.preloan.value = 1.7;
        document.calc.payyears.value = 20;
        document.calc.rate.value = 5.5;
        document.calc.aadt.value = 5980;
        document.calc.trafficgrowth.value = 2;
        document.calc.bomselskap.value = 6;
        document.calc.heavyratio.value = 12;
        document.calc.heavymult.value = 3;
        document.calc.elratio.value = 30;
        document.calc.elrabatt.value = 50;
        document.calc.intoll.value = "409 kr, St.prop. 54 S 2020";
    }

    // https://www.regjeringen.no/contentassets/72a5e7fc2d5048a0a4268aa2714301f5/no/pdfs/prp201020110103000dddpdfs.pdf
    function grime_vesleelva() {
        document.calc.buildyears.value = 2;
        document.calc.totalkost.value = 0.193;
        document.calc.totalkostramme.value = 0.193;
        document.calc.loan.value = 0.101;
        document.calc.preloan.value = 0;
        document.calc.payyears.value = 15;
        document.calc.rate.value = 8;
        document.calc.aadt.value = 1500;
        document.calc.trafficgrowth.value = 1.1;
        document.calc.bomselskap.value = 3;
        document.calc.heavyratio.value = 15;
        document.calc.heavymult.value = 2;
        document.calc.elratio.value = 0;
        document.calc.elrabatt.value = 100;
        document.calc.intoll.value = "24.5 kr, St.prop. 103 S 2010";
    }

    function kilden_presterudskrysset() {
        document.calc.buildyears.value = 2;
        document.calc.totalkost.value = 0.226;
        document.calc.totalkostramme.value = 0.226;
        document.calc.loan.value = 0.194;
        document.calc.preloan.value = 0;
        document.calc.payyears.value = 4;
        document.calc.rate.value = 5.5;
        document.calc.aadt.value = 10800;
        document.calc.trafficgrowth.value = 1.7;
        document.calc.bomselskap.value = 3;
        document.calc.heavyratio.value = 7;
        document.calc.heavymult.value = 2;
        document.calc.elratio.value = 0;
        document.calc.elrabatt.value = 100;
        document.calc.intoll.value = "13.5 kr, St.prop. 103 S";
    }

    function foenhus_bagn() {
        document.calc.buildyears.value = 3;
        document.calc.totalkost.value = 0.420;
        document.calc.totalkostramme.value = 0.444;
        document.calc.loan.value = 0.220;
        document.calc.preloan.value = 0;
        document.calc.payyears.value = 15;
        document.calc.rate.value = 6.5;
        document.calc.aadt.value = 2200;
        document.calc.trafficgrowth.value = 1;
        document.calc.bomselskap.value = 3;
        document.calc.heavyratio.value = 13;
        document.calc.heavymult.value = 2;
        document.calc.elratio.value = 0;
        document.calc.elrabatt.value = 100;
        document.calc.intoll.value = "30 kr, St.prop.";
    }

</script>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" charset="UTF-8">
    <style>
        body {
            font-family: 'Courier New', monospace;
        }

        input[type="text"] {
            font-size: 14px;
            font-family: 'Courier New', monospace;
        }

        #knapp {
            border-collapse: collapse;
            width: 95%;
        }

        #knapp td,
        #knapp th {
            border: 0px solid #ddd;
            padding: 8px;
        }

        /* #knapp tr:nth-child(even) {
            background-color: #f2f2f2;
        } */

        #bom {
            font-family: 'Courier New', monospace;
            border-collapse: collapse;
            width: 95%;
        }

        #bom input {
            border: 1px solid #ddd;
            padding: 6px;
        }

        #bom td,
        #bom th {
            border: 1px solid #ddd;
            padding: 6px;
        }

        #bom tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        #bom tr:hover {
            background-color: #ddd;
        }

        #bom th {
            padding-top: 12px;
            padding-bottom: 12px;
            text-align: left;
            background-color: #5b5b5c;
            color: white;
        }


        #res {
            border-collapse: collapse;
            width: 95%;
        }

        #res td,
        #res th {
            border: 1px solid #ddd;
            padding: 6px;
        }


        #res tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        #res tr:nth-child(1) {
            background-color: #c58080;
        }


        #res input {
            border: 1px solid #ddd;
            padding: 6px;
        }

        #res th {
            padding-top: 12px;
            padding-bottom: 12px;
            text-align: left;
            background-color: #682288;
            color: white;
        }

        .button {
            background-color: #616909;
            font-family: 'Courier New', monospace;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 22px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 6px;
        }

        .button3 {
            background-color: #A44400;
        }

        .button4 {
            background-color: #e597f0;
            padding: 10px 32px;
            font-size: 13px;
            color: black;
            border-radius: 6px;
        }

        div.a {
            text-align: left;
            font-size: 12px;
            font-family: 'Helvetica';
            text-indent: 70px;
        }

        div.b {
            font-size: 16px;
            font-family: 'Helvetica';
            color: #A44400;

            text-indent: 70px;
        }

        ul.a {
            text-align: left;
            font-size: 14px;
            font-family: 'Helvetica';
            margin-left: 40px;
            margin-right: 40px;
        }

        /* Red */
    </style>
</head>

<body>

    <p>


        <center>
            <div class="b">
                <h3>Instruksjon:
                    Trykk på en av de lilla knappene under for eksempelinnfylling. Trykk så
                    på <b>Beregn</b> knappen. Juster tall og se effekt. </h3>
            </div>
            <br>
            <form name=calc method=POST>
                <table id="bom">
                    <tr>
                        <th width=70%>Beskrivelse</th>
                        <th width=30%>Inngangsdata</th>
                    </tr>
                    <tr>
                        <td>Byggetid (hele år)</td>
                        <td><input type=text name=buildyears size=10></td>
                    </tr>
                    <tr>
                        <td>Total kostnad styringsramme (MRD kr)</td>
                        <td><input type=text name=totalkost size=10></td>
                    </tr>
                    <tr>
                        <td>Total kostnad kostnadsramme (MRD kr)</td>
                        <td><input type=text name=totalkostramme size=10></td>
                    </tr>
                    <tr>
                        <td>Bompengelån for etterskuddsinnkreving (MRD kr)</td>
                        <td><input type=text name=loan size=10></td>
                    </tr>
                    <tr>
                        <td>Forhåndsinnkreving (sum, for info) (MRD kr)</td>
                        <td><input type=text name=preloan size=10></td>
                    </tr>
                    <tr>
                        <td>Nedbetalingstid (år)</td>
                        <td><input type=text name=payyears size=10></td>
                    </tr>
                    <tr>
                        <td>Lånerente i %</td>
                        <td><input type=text name=rate size=10></td>
                    </tr>
                    <tr>
                        <td>ÅDT oppstart</td>
                        <td><input type=text name=aadt size=10></td>
                    </tr>
                    <tr>
                        <td>Forventet trafikkvekst per år %</td>
                        <td><input type=text name=trafficgrowth size=10></td>
                    </tr>
                    <tr>
                        <td>Årlig betaling til bomselskap (mill. kr)</td>
                        <td><input type=text name=bomselskap size=10></td>
                    </tr>
                    <tr>
                        <td>Andel tunge kjøretøy %</td>
                        <td><input type=text name=heavyratio size=10></td>
                    </tr>
                    <tr>
                        <td>Bompengefaktor (multiplikator) tunge kjøretøy</td>
                        <td><input type=text name=heavymult size=10></td>
                    </tr>
                    <tr>
                        <td>Lette kjøretøy, elbil andel %</td>
                        <td><input type=text name=elratio size=10></td>
                    </tr>
                    <tr>
                        <td>Elbil pris% av lett fossilbil (typisk 50%) %</td>
                        <td><input type=text name=elrabatt size=10></td>
                    </tr>
                    <tr>
                        <td style="color: #74178b;" ;">Gjennomsnitt bompenger offisielt fra vedtak eller kjent svar
                        </td>
                        <td><input type=text name=intoll size=25 style="background-color:#dd92f0;" readonly></td>
                    </tr>
                </table>
            </form>
            <br>
            <h3>Fyll inn ved å trykke på en av de lilla knappene</h3>
            <form name=case method=POST>
                <table id="knapp">

                    <tr>
                        <td align=center><input type=button class="button button4" onClick='testcase()' value=Generell>
                        </td>
                        <td align=center><input type=button class="button button4" onClick='rogfast1()' value=Rogfast>
                        </td>
                        <td align=center><input type=button class="button button4" onClick='hordfast1()' value=Hordfast>
                        </td>
                    </tr>
                    <tr>
                        <td align=center><input type=button class="button button4" onClick='grime_vesleelva()'
                                value=Grime-Vesleelva>
                        <td align=center><input type=button class="button button4" onClick='kilden_presterudskrysset()'
                                value=Kilden-Presterudkrysset>
                        </td>
                        <td align=center><input type=button class="button button4" onClick='foenhus_bagn()'
                                value=Fønhus-Bagn>
                        </td>

                    </tr>
                </table>
            </form>
            <br>
            <h3>Beskrivelse</h3>
            <ul class="a">
                <li>Generell: Enkelt test eksempel</li>
                <li>E39 Rogfast: Fra <A
                        HREF=https://www.regjeringen.no/contentassets/8e5b283f2fd34f7b8559705ad9d2502b/nn-no/pdfs/prp202020210054000dddpdfs.pdf>stortingsproposisjon
                        2020-2021</A>
                    Bompengesummesummen er her begrenset til det som skal innkreves etter åpning. Det er i tillegg
                    forhåndsinnkreving i perioden 2013-2030 på fergen (ca 1,7 milliarder i sum). Tilsammen blir
                    bompenger betalt i 37 år!</li>
                <li>E39 Hordfast: Kostnadstall og bompengenandel fra <A
                        HREF=https://www.regjeringen.no/contentassets/7cb4217acb094720905ba6c438cd3ab7/svv-vedlegg-1-leveranse-til-sd-endelig.pdf>
                        innspill til NTP høsten 2020.</A>
                    Hvordan og hvorfor ÅDT skal øke fra dagens 3100 til 5700 i 2030 selv
                    med så høye bompenger er ikke lett å forstå!</li>
                <li>FV. 34 Grime-Vesleelva for validering: Fra <A
                        HREF=https://www.regjeringen.no/contentassets/72a5e7fc2d5048a0a4268aa2714301f5/no/pdfs/prp201020110103000dddpdfs.pdf>prop
                        103 S (2010-2011)</A></li>
                <li>FV. 311 Kilden-Presterudkrysset for validering: Fra <A
                        HREF=https://www.regjeringen.no/contentassets/0b1c67e1808d45d29e474abd16125416/no/pdfs/prp201720180103000dddpdfs.pdf>prop
                        103 S (2017-2018)</A></li>
                <li>E16 Fønhus-Bagn for validering: Fra <A
                        HREF=https://www.regjeringen.no/contentassets/262884fcb4ac4a21a69b1b809bc3dae4/no/pdfs/prp201120120101000dddpdfs.pdf>prop.
                        101 S (2011-2012)</A>
                </li>
            </ul>
            <hr>
            <br>
            <br>
            <form name=knapp method=POST>
                <table id=" knapp">

                    <tr>
                        <td align=center width=50%><input type=button class="button" onClick='main()' value="Beregn"
                                <Input>
                        </td>
                        <td align=center width=50%><input type=button class="button button3" onClick='testcase()'
                                value="Reset" <Input>
                        </td>
                    </tr>
                </table>
            </form>
            <br>
            <br>
            <form name=result method=POST>
                <span style="font-size: 250%" id="emoji"></span>
                <br>
                <span style="font-size: 120%" id="umulig"></span>
                <table id="res">
                    <tr>
                        <th width=70%>Beregnede verdier</th>
                        <th width=30%>Verdi</th>
                    </tr>
                    <tr style="background-color:#d897fd; font-size: 20px;font-weight: 800;">
                        <td>Estimert gjennomsnitt bomtakst</td>
                        <td><input type=text name=proposed size=10 readonly
                                style="background-color:#fbe5ba; font-size: 20px; font-weight: 800;"> kr</td>
                    </tr>
                    <tr>
                        <td>Bompenger lett bil fossil</td>
                        <td><input type=text name=propfossil size=10 readonly> kr</td>

                    </tr>
                    <tr>
                        <td>Bompenger lett bil el</td>
                        <td><input type=text name=propelbil size=10 readonly> kr</td>
                    </tr>
                    <tr>
                        <td>Bompenger tunge kjøretøy</td>
                        <td><input type=text name=proptung size=10 readonly> kr</td>
                    </tr>
                    <tr>
                        <td>Kumulativ kostnad bompengelån med renter</td>
                        <td><input type=text name=cumloan size=10 readonly> MRD kr</td>
                    </tr>
                    <tr>
                        <td>Kumulativ kostnad som over + drift bomselskap</td>
                        <td><input type=text name=cumloanall size=10 readonly> MRD kr</td>
                    </tr>
                    <tr>
                        <td>Total kumulativ kostnad bompenger inkl evt forh. innkreving</td>
                        <td><input type=text name=cumloanallplus size=10 readonly> MRD kr</td>
                    </tr>
                    <tr>
                        <td>Statlig bidrag %</td>
                        <td><input type=text name=statandel size=10 readonly> %</td>
                    </tr>
                </table>
            </form>

        </center>
    </p>
</body>

</html>
